<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>점수 계산</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <!-- HEIC 변환 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <style>
        /* 기본 버튼 스타일 */
        input[type="submit"],
        .custom-file-upload {
            display: block;
            width: 200px;
            max-width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            text-align: center;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease-in-out;
        }

        /* 파일 업로드 버튼 */
        .custom-file-upload {
            background-color: #4CAF50;
            color: white;
        }

        .custom-file-upload:hover {
            background-color: #4CAF50;
        }

        /* 계산하기 버튼 */
        input[type="submit"] {
            background-color: #4CAF50;
            color: white;
        }

        input[type="submit"]:hover {
            background-color: #4CAF50;
        }

        /* 이미지 크롭 관련 스타일 */
        .img-container {
            max-width: 100%;
            margin-bottom: 20px;
            display: none;
        }
        
        #cropImage {
            max-width: 100%;
        }
        
        .cropper-container {
            margin-bottom: 15px;
            max-width: 100% !important;
            overflow: visible !important; /* 스크롤 허용 */
        }

        /* 로딩 인디케이터 */
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        .btn {
                display: inline-block;
                text-decoration: none;
                font-size: 18px;
                border-radius: 5px;
                color:aliceblue;
                padding: 12px 24px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 반응형 웹 적용 */
        @media screen and (max-width: 600px) {
            input[type="submit"],
            .custom-file-upload {
                width: 50%;
                padding: 15px;
                font-size: 18px;
                background-color: #4CAF50;
                color: white;
            }
            
            /* 모바일에서 크롭 핸들 크기 확대 */
            .cropper-point {
                width: 20px !important;
                height: 20px !important;
                opacity: 0.5;
            }
            
            .cropper-line {
                width: 5px !important;
                height: 5px !important;
            }
        }
    </style>
</head>
<body>
    <h1>점수 계산</h1>
    <div class="mahjong-input-form">
        <form action="/score" method="POST" enctype="multipart/form-data" id="score-form">
            <div class="upload-section">
                <label for="file-input" class="custom-file-upload">
                    사진 선택하기
                </label>
                <input type="file" id="file-input" name="file" accept="image/*" style="display: none;" required>
                
                <!-- 로딩 인디케이터 -->
                <div class="loading" id="loading-indicator">
                    <div class="loading-spinner"></div>
                    <p>이미지 처리 중...</p>
                </div>
                
                <!-- 이미지 크롭 컨테이너 -->
                <div class="img-container">
                    <img id="cropImage" src="#">
                </div>
            </div>

            <!-- 화료 패 선택 -->
            <div class="tile-selection">
                <h3>화료 패 선택</h3>
                <div class="tile-grid" id="winning-tile-selection">
                    <!-- 마작패 이미지들이 여기에 동적으로 로드됨 -->
                </div>
                <div id="selected-winning-tile"></div>
            </div>

            <!-- 도라 표시패 선택 -->
            <div class="tile-selection">
                <h3>도라 표시패 선택</h3>
                <div class="tile-grid" id="dora-tile-selection">
                    <!-- 마작패 이미지들이 여기에 동적으로 로드됨 -->
                </div>
                <div id="selected-dora-tiles"></div>
            </div>

            <!-- 안깡 타일 선택 -->
            <div class="tile-selection">
                <h3>안깡 타일 선택</h3>
                <div class="tile-grid" id="ankan-tile-selection">
                    <!-- 마작패 이미지들이 여기에 동적으로 로드됨 -->
                </div>
                <div id="selected-ankan-tiles"></div>
            </div>

            <!-- 밍 타일 선택 추가 -->
            <div class="tile-selection">
                <h3>명깡/대명깡/가깡/밍커 타일 선택</h3>
                <div class="tile-grid" id="ming-tile-selection">
                    <!-- 마작패 이미지들이 여기에 동적으로 로드됨 -->
                </div>
                <div id="selected-ming-tiles"></div>
            </div>

            <!-- 기타 입력 옵션들 -->
            <div class="options-section">
                <div class="toggle-options">
                    <!-- 기본 옵션 -->
                    <label>
                        <input type="checkbox" name="tsumo"> 쯔모
                    </label>
                    <label>
                        <input type="checkbox" name="riichi"> 리치
                    </label>
                    <label>
                        <input type="checkbox" name="double_riichi"> 더블리치
                    </label>
                    <label>
                        <input type="checkbox" name="huro"> 후로
                    </label>
                    
                    <!-- 추가 옵션들 -->
                    <label>
                        <input type="checkbox" name="one_shot"> 일발
                    </label>
                    <label>
                        <input type="checkbox" name="flower_on_mount"> 영상개화
                    </label>
                    <label>
                        <input type="checkbox" name="last_tile_win"> 해저/하저
                    </label>
                    <label>
                        <input type="checkbox" name="steal_kang"> 창깡
                    </label>
                    <label>
                        <input type="checkbox" name="tian_hu_di_hu"> 천화/지화
                    </label>
                    
                    <!-- 장/본장 선택 -->
                    <div class="round-selection">
                        <select name="main_round" required>
                            <option value="east">동장</option>
                            <option value="south">남장</option>
                            <option value="west">서장</option>
                            <option value="north">북장</option>
                        </select>
                        <select name="round_count">
                            <option value="0">0본장</option>
                            <option value="1">1본장</option>
                            <option value="2">2본장</option>
                            <option value="3">3본장</option>
                            <option value="4">4본장</option>
                        </select>
                    </div>
                    
                    <!-- 자리 선택 -->
                    <div class="seat-selection">
                        <select name="seat">
                            <option value="east">동가</option>
                            <option value="south">남가</option>
                            <option value="west">서가</option>
                            <option value="north">북가</option>
                        </select>
                    </div>
                </div>                
            </div>
            <button class="btn" style="background-color: #4CAF50;">계산하기</button>
            <a href="/" class="btn" style="background-color: #2196F3; float: right;">메인으로 돌아가기</a>
        </form>
    </div>

    <!-- Cropper.js 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // 필요한 요소 가져오기
        const fileInput = document.getElementById('file-input');
        const imgContainer = document.querySelector('.img-container');
        const cropImage = document.getElementById('cropImage');
        const form = document.getElementById('score-form');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        let cropper;
        
        // 모바일 환경 감지
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // HEIC 파일인지 확인하는 함수
        function isHeicFile(file) {
            return file.name.toLowerCase().endsWith('.heic') || 
                   file.name.toLowerCase().endsWith('.heif') ||
                   file.type === 'image/heic' || 
                   file.type === 'image/heif';
        }
        
        // 이미지 리사이징 함수
        function resizeImage(img, maxWidth, maxHeight) {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            if (width > height) {
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width *= maxHeight / height;
                    height = maxHeight;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            return canvas.toDataURL('image/jpeg', 0.85);
        }
        
        // 이미지 처리 함수
        function processImage(file, reader) {
            reader.onload = function(e) {
                // 이미지 소스 설정
                const img = new Image();
                img.onload = function() {
                    // 이미지 크기 확인 및 리사이징
                    let imageData = e.target.result;
                    
                    // 이미지가 너무 큰 경우 리사이징
                    if (img.width > 2000 || img.height > 2000) {
                        imageData = resizeImage(img, 2000, 2000);
                    }
                    
                    // 이미지 표시
                    cropImage.src = imageData;
                    imgContainer.style.display = 'block';
                    loadingIndicator.style.display = 'none';
                    
                    // 기존 Cropper 인스턴스 제거
                    if (cropper) {
                        cropper.destroy();
                    }
                    
                    // 새 Cropper 인스턴스 생성
                    cropper = new Cropper(cropImage, {
                        viewMode: 1,
                        dragMode: 'none',  // 'crop'에서 'none'으로 변경하여 새 영역 생성 방지
                        aspectRatio: NaN,
                        autoCropArea: 0.8, // 초기 크롭 영역 크기
                        initialAspectRatio: NaN,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: true,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        zoomOnWheel: false,
                        responsive: !isMobile,
                        ready: function() {
                            const cropperContainer = document.querySelector('.cropper-container');
                            cropperContainer.style.overflow = 'visible';
                            
                            // 모바일 환경에서 스크롤 개선
                            if (isMobile) {
                                // 크롭 영역 외부 터치 이벤트 처리
                                document.addEventListener('touchmove', function(e) {
                                    // 기본 스크롤 동작 허용
                                }, { passive: true });
                                
                                // 크롭 영역 내부에서만 이벤트 가로채기
                                const cropBox = document.querySelector('.cropper-crop-box');
                                if (cropBox) {
                                    cropBox.addEventListener('touchmove', function(e) {
                                        // 크롭 영역 내부에서만 이벤트 가로채기
                                        e.stopPropagation();
                                    }, { passive: false });
                                }
                            }
                        }
                    });
                };
                
                img.onerror = function() {
                    loadingIndicator.style.display = 'none';
                    alert('이미지를 로드할 수 없습니다. 다른 이미지를 선택해주세요.');
                };
                
                img.src = e.target.result;
            };
            
            reader.onerror = function() {
                loadingIndicator.style.display = 'none';
                alert('파일을 읽는 중 오류가 발생했습니다.');
            };
            
            reader.readAsDataURL(file);
        }
        
        // 파일 선택 시 이벤트
        fileInput.addEventListener('change', function(e) {
            const files = e.target.files;
            
            if (files && files.length > 0) {
                const file = files[0];
                
                // 파일이 이미지인지 확인
                if (!file.type.match('image.*') && !isHeicFile(file)) {
                    alert('이미지 파일만 선택할 수 있습니다.');
                    return;
                }
                
                // 로딩 인디케이터 표시
                loadingIndicator.style.display = 'block';
                
                // HEIC 파일 처리
                if (isHeicFile(file)) {
                    console.log('HEIC 파일 감지: 변환 시작');
                    
                    // heic2any 라이브러리를 사용하여 HEIC를 JPEG로 변환
                    heic2any({
                        blob: file,
                        toType: 'image/jpeg',
                        quality: 0.8
                    })
                    .then(function(jpegBlob) {
                        // 변환된 JPEG 파일로 처리 계속
                        const jpegFile = new File([jpegBlob], file.name.replace(/\.heic$/i, '.jpg'), {type: 'image/jpeg'});
                        const reader = new FileReader();
                        processImage(jpegFile, reader);
                    })
                    .catch(function(error) {
                        loadingIndicator.style.display = 'none';
                        console.error('HEIC 변환 오류:', error);
                        alert('HEIC 이미지 변환 중 오류가 발생했습니다. 다른 이미지를 선택해주세요.');
                    });
                } else {
                    // 일반 이미지 파일 처리
                    const reader = new FileReader();
                    processImage(file, reader);
                }
            }
        });
        
        // 폼 제출 시
        form.addEventListener('submit', function(e) {
            if (cropper) {
                e.preventDefault();
                loadingIndicator.style.display = 'block';
                
                // 크롭된 캔버스 가져오기
                cropper.getCroppedCanvas({
                    maxWidth: 2000, // 최대 너비 제한
                    maxHeight: 2000, // 최대 높이 제한
                    fillColor: '#fff',
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high',
                }).toBlob(function(blob) {
                    // 크롭된 이미지를 파일 입력에 설정
                    const croppedFile = new File([blob], 'cropped.jpg', { type: 'image/jpeg' });
                    
                    // 새 FormData 객체 생성
                    const formData = new FormData(form);
                    
                    // 기존 파일 제거 및 크롭된 파일 추가
                    formData.delete('file');
                    formData.append('file', croppedFile);
                    
                    // AJAX 요청으로 폼 제출
                    fetch('/score', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.text())
                    .then(html => {
                        loadingIndicator.style.display = 'none';
                        document.open();
                        document.write(html);
                        document.close();
                    })
                    .catch(error => {
                        loadingIndicator.style.display = 'none';
                        console.error('Error:', error);
                        alert('이미지 업로드 중 오류가 발생했습니다.');
                    });
                }, 'image/jpeg', 0.85); // 품질 85%로 설정하여 용량 감소
            }
        });
    });
    </script>

    <script src="{{ url_for('static', filename='js/mahjong.js') }}"></script>
</body>
</html>
